# 알림 비활성화 배치 최적화

## 개요

사용자의 방문 이력을 기반으로 구독 알림을 중지하는 배치 작업이 점점 느려져, 서비스 운영에 부담을 주고 있었습니다. 매일 수십만 건의 구독 데이터를 전수 조회하는 기존 방식의 병목을 해결하기 위해, **쿼리 범위를 제한하고, 배치 수행 시간을 획기적으로 줄이는 리팩토링**을 주도했습니다.

## 문제 상황

- 매일 알림 설정 데이터에 대해 사용자의 알림 활성화 조건을 확인했습니다.
- 실제 상태 변경 대상은 일부에 불과하지만 배치시간이 150분 이상 소요되었습니다.

## 개선 목표

- 불필요한 연산을 줄여 **배치 처리 시간과 DB 부하를 최소화**
- **사용자 수가 증가해도** 일정한 성능을 유지할 수 있는 구조로 개선
- 신규 로직 도입 시 안정적인 마이그레이션과 인덱스 설정

## 해결 전략

<img src="image/batch-optimization/1747760690283.png" alt="구독 상태 갱신 흐름" width="400px">

### 1.개선 방향 설계

- `nextRenewalAt` 필드를 추가하여, 상태 갱신이 필요한 시점을 명시
- `nextRenewalAt = 오늘`인 도큐먼트만 조회하여 처리량 최소화
- MongoDB 커서를 활용해 데이터를 100개 단위로 처리
- 방문 기준 조건 분기 처리:
  - 최근 14일 이내 방문: `nextRenewalAt`을 14일 후로 연장
  - 미방문: 알림 중단

### 2. 마이그레이션 설계 및 실행

- 기존 문서에 대해 `lastVisitedAt` 기준으로 `nextRenewalAt` 초기값 설정
- 시스템 부하 방지를 위해 `p-throttle` 기반으로 스로틀링 적용
  - 200ms당 최대 50개 작업만 실행 (`limit: 50`, `interval: 200`)
  - 드라이런을 통해 스로틀링 값을 검증하고 실제 마이그레이션 수행

### 4. **쿼리 성능 개선을 위한 인덱스 설계**

- `nextRenewalAt` 필드에 복합 인덱스를 적용하여 조회 속도 최적화

## 성과

- 배치 수행 시간 **150분 → 20초**로 단축 (99.8% 이상 개선)
- 사용자 수 증가와 무관하게 일정한 성능 유지 가능한 구조 확보
- MongoDB 부하 감소

## 사용 기술 및 도구

- MongoDB: 인덱스 추가, 커서
- Node.js
- 스케줄링: 매일 배치 실행 설정
- `p-throttle`: 작업 제한을 통한 스로틀링 적용
- Slack 알림, Grafana 로그 모니터링

## 개인 기여

- 문제 정의 및 리팩토링 구조 설계 주도
- 마이그레이션 스크립트 및 인덱스 적용
- 신규 로직 테스트 및 배치 안전성 검증
- 운영 환경 반영을 위한 배포 플랜 수립 및 모니터링 지원

## 회고

병목 지점을 정확히 파악하고, 성능 향상 효과가 높은 구간부터 우선 최적화하는 판단이 중요했던 경험이었습니다. 쿼리 최적화에만 집중하는 것이 아니라, 데이터 구조, 처리 방식, 인덱스, 시스템 자원 사용까지 포괄적으로 고려해야 실질적인 성능 개선이 이루어진다는 것을 배웠습니다. 문제를 코드 단위가 아니라 데이터 흐름과 시스템 구조 관점에서 정의하고 접근하는 습관을 가지게 되었고, 성능 개선은 우선순위 선정과 구조적 판단이 중요하다는 점일 배웠습니다.
